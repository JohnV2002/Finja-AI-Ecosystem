<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Finjas Musik-Steuerung</title>
    <style>
        body { font-family: system-ui, sans-serif; background-color: #1f1f1f; color: #fff; text-align: center; padding: 20px; }
        h1, h2 { color: #a07aff; }
        h2 { border-top: 1px solid #444; padding-top: 25px; margin-top: 30px; }
        p { color: #ccc; }
        .container { max-width: 600px; margin: 0 auto; }
        .button-group { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-top: 20px; }
        button {
            border: none; padding: 12px 24px; font-size: 16px; font-weight: bold;
            border-radius: 10px; cursor: pointer; transition: all 0.2s; width: 80%;
        }
        button:hover { transform: scale(1.03); }

        /* Stile für Quellen-Buttons */
        .btn-source { background-color: #76f7ff; color: #1f1f1f; }
        .btn-source.active { background-color: #a07aff; color: #fff; }
        .btn-deactivate { background-color: #ff7a7a; color: #fff; margin-top: 5px; }

        /* Stile für Hilfsskript-Buttons */
        .btn-helper { background-color: #4a4a4a; color: #fff; border: 1px solid #666; }
        .btn-helper:hover { background-color: #5a5a5a; }

        #status { margin-top: 25px; min-height: 20px; font-style: italic; color: #88ff88; }
        /* Neuer Stil für deaktivierte Buttons */
        .btn-disabled { opacity: 0.5; cursor: not-allowed; }
        /* Stil für den deaktivierten RTL-Button (Rot) */
        #btn-rtl:disabled {
            background-color: #ff7a7a; /* Rote Farbe fuer deaktiviert */
            color: #fff;
            border: 1px solid #cc5555;
        }
        /* Stil für den aktivierten RTL-Button (Gruen) */
        #btn-rtl:not(:disabled) {
            background-color: #55cc55; /* Gruene Farbe fuer aktiviert */
            color: #1f1f1f;
            border: 1px solid #76f7ff;
        }
        #btn-mdr:disabled {
            background-color: #ff7a7a; /* Rote Farbe fuer deaktiviert */
            color: #fff;
            border: 1px solid #cc5555;
        }
        /* Stil für den aktivierten RTL-Button (Gruen) */
        #btn-mdr:not(:disabled) {
            background-color: #55cc55; /* Gruene Farbe fuer aktiviert */
            color: #1f1f1f;
            border: 1px solid #76f7ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Finjas Musik-Steuerung</h1>
        <p id="status">Bereit für deine Befehle. :3</p>

        <h2>Musikquellen</h2>
        <div class="button-group" id="source-controls">
            <button id="btn-truckersfm" class="btn-source" onclick="handleSourceClick('truckersfm')">TruckersFM aktivieren</button>
            <button id="btn-spotify" class="btn-source" onclick="handleSourceClick('spotify')">Spotify aktivieren</button>
            <!-- NEU: RTL-Quellen-Button -->
            <button id="btn-rtl" class="btn-source" onclick="handleSourceClick('rtl')" disabled>RTL 98.0 aktivieren</button>
            <button id="btn-mdr" class="btn-source" onclick="handleSourceClick('mdr')" disabled>MDR aktivieren</button>
        </div>

        <h2>DB und Hilfsskripte</h2>
        <div class="button-group">
            <button class="btn-helper" onclick="runHelper('build_db')">1. Spotify-Exporte in DB bauen</button>
            <button class="btn-helper" onclick="runHelper('enrich_missing')">2. Fehlende Songs via Spotify anreichern</button>
            <button class="btn-helper" onclick="runHelper('review_artist_queue_ps')">3. Artist-Konflikte prüfen Html</button>
            <!-- NEU: RTL-Hilfs-Button -->
            <button class="btn-helper" onclick="runHelper('rtl_start_browser')">3. Starte RTL Browser (Chrome CDP)</button>
            <!-- In der Button-Gruppe fuer Hilfsskripte -->
            <button class="btn-helper" onclick="runHelper('gimick_repeat_counter')">4. Starte RTL Wiederholungs-Zähler</button>
            <!-- NEU: MDR-Hilfs-Button -->
            <button class="btn-helper" onclick="runHelper('start_mdr')">5. Starte MDR NowPlaying (XML/HTML/ICY)</button>
        </div>
    </div>

    <script>
        const statusElement = document.getElementById('status');
        let activeSource = null;
        let rtlBrowserStarted = false; // Zustand für RTL-Browser

        // Funktion für die MUSIKQUELLEN
        async function handleSourceClick(sourceName) {
            if (sourceName === 'rtl' && !rtlBrowserStarted) {
                statusElement.textContent = 'Fehler: Bitte zuerst den RTL-Browser starten (Button unter "DB und Hilfsskripte").';
                return;
            }

            if (activeSource === sourceName) {
                // Wenn die Quelle schon aktiv ist -> Neustart
                await sendCommand(`/activate/${sourceName}`, `Starte '${sourceName}' neu...`);
            } else {
                // Eine neue Quelle aktivieren
                await sendCommand(`/activate/${sourceName}`, `Aktiviere '${sourceName}'...`);
            }
        }

        function updateSourceButtons(sourceName) {
            activeSource = sourceName;
            
            // Alten Deaktivieren-Button entfernen, falls vorhanden
            const oldDeactivateBtn = document.getElementById('btn-deactivate');
            if(oldDeactivateBtn) oldDeactivateBtn.remove();

            // Alle Quellen-Buttons zurücksetzen
            document.querySelectorAll('.btn-source').forEach(b => {
                b.classList.remove('active');
                b.textContent = b.textContent.replace('Neustarten', 'aktivieren');
            });
            
            if (sourceName) {
                const activeButton = document.getElementById(`btn-${sourceName}`);
                activeButton.classList.add('active');
                activeButton.textContent = `${sourceName.charAt(0).toUpperCase() + sourceName.slice(1)} neustarten`;

                // Neuen Deaktivieren-Button erstellen und einfügen
                const deactivateBtn = document.createElement('button');
                deactivateBtn.id = 'btn-deactivate';
                deactivateBtn.className = 'btn-deactivate';
                deactivateBtn.textContent = 'Aktive Quelle deaktivieren';
                deactivateBtn.onclick = () => sendCommand('/deactivate', 'Deaktiviere Quelle...');
                activeButton.after(deactivateBtn);
            }
        }

        async function runHelper(scriptName) {
            if (scriptName === 'review_artist_queue_ps') { // Spezielle Behandlung für den neuen Button
                // 1. Aktiven Stream stoppen
                await sendCommand('/deactivate', 'Stoppe aktiven Stream für Artist-Prüfung...');

                // 2. Neuen Tab mit ArtistNotSure.html öffnen
                window.open('http://localhost:8022/ArtistNotSure.html', '_blank');

                // Optional: Status aktualisieren
                statusElement.textContent = 'Stream gestoppt. Web-UI zur Artist-Prüfung geöffnet.';
                return; // Verlasse die Funktion, damit der normale Ablauf unten nicht passiert
            }
            // --- NEU: Spezielle Behandlung für 'enrich_missing' ---
            if (scriptName === 'enrich_missing') {
                // 1. Aktiven Stream stoppen
                await sendCommand('/deactivate', 'Stoppe aktiven Stream für Spotify-Anreicherung...');
                // 2. Führe die Anreicherung aus
                await sendCommand(`/run/${scriptName}`, `Führe Spotify-Anreicherung aus...`);
                // Optional: Status aktualisieren, z.B. mit der Antwort des Servers
                // (Die Antwort enthält Erfolg/Status, du könntest sie hier verarbeiten)
                // statusElement.textContent = 'Spotify-Anreicherung abgeschlossen.';
                return; // Verlasse die Funktion, damit der normale Ablauf unten nicht passiert
            }
            // --- NEU: Spezielle Behandlung für 'start_rtl' ---
            if (scriptName === 'rtl_start_browser') { // <-- NEUER NAME
                statusElement.textContent = 'Starte RTL-Browser (Chrome)...';
                try {
                    // Dieser Befehl wird vom Server verarbeitet, z.B. indem er die .bat ausfuehrt
                    const response = await fetch(`/run/${scriptName}`); // <-- NEUER ENDPOINT NAME
                    const result = await response.json();

                    if (result.success) {
                        statusElement.textContent = `Erfolg: ${result.message}`;
                        // Setze den Zustand, dass der Browser gestartet wurde
                        rtlBrowserStarted = true;
                        // Aktiviere den RTL-Quellen-Button
                        const rtlButton = document.getElementById('btn-rtl');
                        rtlButton.disabled = false;
                        rtlButton.textContent = 'RTL 98.0 aktivieren';
                        rtlButton.title = 'Klicke, um den RTL-Stream zu aktivieren.';
                    } else {
                        statusElement.textContent = `Fehler: ${result.message}`;
                    }
                } catch (error) {
                    statusElement.textContent = 'Fehler: Der Server ist nicht erreichbar oder hat den Befehl nicht verstanden.';
                    console.error('Fehler beim Senden des RTL-Start-Befehls:', error);
                }
                return; // Verlasse die Funktion, damit der normale Ablauf unten nicht passiert
            }
            if (scriptName === 'gimick_repeat_counter') { // <-- NEUER NAME
                statusElement.textContent = 'Starte RTL Wiederholungs-Zaehler...';
                try {
                    // Dieser Befehl wird vom Server verarbeitet, z.B. indem er die .bat ausfuehrt
                    const response = await fetch(`/run/${scriptName}`); // <-- NEUER ENDPOINT NAME
                    const result = await response.json();

                    if (result.success) {
                        statusElement.textContent = `Erfolg: ${result.message}`;
                    } else {
                        statusElement.textContent = `Fehler: ${result.message}`;
                    }
                } catch (error) {
                    statusElement.textContent = 'Fehler: Der Server ist nicht erreichbar oder hat den Befehl nicht verstanden.';
                    console.error('Fehler beim Senden des RTL-Repeat-Counter-Start-Befehls:', error);
                }
                return; // Verlasse die Funktion, damit der normale Ablauf unten nicht passiert
            }
                    if (scriptName === 'start_mdr') {
            statusElement.textContent = 'Starte MDR NowPlaying (XML/HTML/ICY)...';
            try {
                const response = await fetch(`/run/${scriptName}`);
                const result = await response.json();

                if (result.success) {
                    statusElement.textContent = `Erfolg: ${result.message}`;
                    // Setze den Zustand, dass der MDR-NowPlaying gestartet wurde
                    // Optional: Füge eine Variable wie mdrNowPlayingStarted hinzu, wenn nötig
                    // Für den Moment reicht es, den Button zu aktivieren
                    const mdrButton = document.getElementById('btn-mdr');
                    mdrButton.disabled = false;
                    mdrButton.textContent = 'MDR aktivieren';
                    mdrButton.title = '';
                } else {
                    statusElement.textContent = `Fehler: ${result.message}`;
                }
            } catch (error) {
                statusElement.textContent = 'Fehler: Der Server ist nicht erreichbar oder hat den Befehl nicht verstanden.';
                console.error('Fehler beim Senden des MDR-Start-Befehls:', error);
            }
            return; // Verlasse die Funktion, damit der normale Ablauf unten nicht passiert
        }
            // ---
            // ... alte Logik für andere Skripte (z.B. build_db) ...
            await sendCommand(`/run/${scriptName}`, `Führe Hilfsskript '${scriptName}' aus...`);
        }
        
        // Allgemeine Funktion, um Befehle an den Server zu senden
        async function sendCommand(endpoint, loadingMessage) {
            statusElement.textContent = loadingMessage;
            try {
                const response = await fetch(endpoint);
                const result = await response.json();

                if (result.success) {
                    statusElement.textContent = `Erfolg: ${result.message}`;
                    // Button-Zustand nur für Quellen-Aktionen aktualisieren
                    if (endpoint.startsWith('/activate/')) {
                        updateSourceButtons(endpoint.split('/')[2]);
                    } else if (endpoint === '/deactivate') {
                        updateSourceButtons(null);
                        // Wenn deaktiviert wird, kann man optional rtlBrowserStarted auf false setzen,
                        // wenn man davon ausgeht, dass der ganze Stream (inkl. externem Skript) gestoppt wird.
                        // Hier erstmal nicht, da der Browser ja weiterlaufen kann.
                    }
                } else {
                    statusElement.textContent = `Fehler: ${result.message}`;
                }
            } catch (error) {
                statusElement.textContent = 'Fehler: Der Server ist nicht erreichbar.';
                console.error('Fehler beim Senden des Befehls:', error);
            }
        }
    </script>
        <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #444; color: #888; font-size: 0.9em;">
        Made by J. Apps (Sodakiller1 auf Twitch)
    </footer>

        <!--

        [[[[[[[[[[[[[[[      ]]]]]]]]]]]]]]]
        [::::::::::::::      ::::::::::::::]
        [::::::::::::::      ::::::::::::::]
        [::::::[[[[[[[:      :]]]]]]]::::::]
        [:::::[                      ]:::::]
        [:::::[                      ]:::::]
        [:::::[                      ]:::::]
        [:::::[        J.Apps        ]:::::]
        [:::::[     CODE THE WEB     ]:::::]
        [:::::[                      ]:::::]
        [:::::[                      ]:::::]
        [:::::[                      ]:::::]
        [:::::[                      ]:::::]
        [:::::[                      ]:::::]
        [::::::[[[[[[[:      :]]]]]]]::::::]
        [::::::::::::::      ::::::::::::::]
        [::::::::::::::      ::::::::::::::]
        [[[[[[[[[[[[[[[      ]]]]]]]]]]]]]]]

    -->
</body>
</html>