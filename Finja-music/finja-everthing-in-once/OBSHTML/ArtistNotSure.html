<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Finjas Artist-Not-Sure Prüfer</title>
    <style>
        body { font-family: system-ui, sans-serif; background-color: #1f1f1f; color: #fff; padding: 20px; }
        h1, h2 { color: #a07aff; }
        .container { max-width: 800px; margin: 0 auto; }
        .entry { background-color: #2a2a2a; border: 1px solid #444; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        .info { margin-bottom: 10px; }
        .info strong { color: #76f7ff; }
        .buttons { display: flex; gap: 10px; margin-top: 10px; }
        button {
            border: none; padding: 8px 16px; font-size: 14px; font-weight: bold;
            border-radius: 5px; cursor: pointer; transition: all 0.2s;
        }
        .btn-confirm { background-color: #76f7ff; color: #1f1f1f; }
        .btn-deny { background-color: #ff7a7a; color: #fff; }
        .btn-allow-title { background-color: #ffa500; color: #fff; }
        .btn-skip { background-color: #666; color: #fff; }
        .btn-confirm:hover { background-color: #90ffff; }
        .btn-deny:hover { background-color: #ff9a9a; }
        .btn-allow-title:hover { background-color: #ffc14d; }
        .btn-skip:hover { background-color: #888; }
        #status { margin-top: 20px; min-height: 20px; font-style: italic; color: #88ff88; }
        #loading { display: none; color: #aaa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Finjas Artist-Not-Sure Prüfer</h1>
        <p>Diese Seite hilft dabei, unklare Artist-Zuordnungen zu korrigieren.</p>

        <div id="loading">Lade Einträge...</div>
        <div id="entries-container"></div>
        <div id="status"></div>
    </div>

    <script>
        const statusElement = document.getElementById('status');
        const loadingElement = document.getElementById('loading');
        const container = document.getElementById('entries-container');

        async function loadAndDisplayEntries() {
            loadingElement.style.display = 'block';
            container.innerHTML = '';
            statusElement.textContent = '';

            try {
                const response = await fetch('/get_artist_not_sure_entries');
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message || 'Unbekannter Fehler');
                }
                const entries = result.entries;

                if (entries.length === 0) {
                    container.innerHTML = '<p>Keine offenen Einträge zur Prüfung.</p>';
                    loadingElement.style.display = 'none';
                    return;
                }

                entries.forEach(entry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'entry';
                    const obs = entry.observed;
                    const kb = entry.kb_entry;
                    entryDiv.innerHTML = `
                        <div class="info"><strong>Beobachtet:</strong> ${escapeHtml(obs.title || '(kein Titel)')} — ${escapeHtml(obs.artist || '(kein Künstler)')}</div>
                        <div class="info"><strong>KB-Eintrag:</strong> ${escapeHtml(kb.title || '(kein Titel)')} — ${escapeHtml(kb.artist || '(kein Künstler)')}</div>
                        <div class="info"><strong>Grund:</strong> ${escapeHtml(entry.reason || 'Unbekannt')}</div>
                        <div class="buttons">
                            <button class="btn-confirm" onclick="performAction('confirm', '${obs.title}', '${obs.artist}', '${kb.title}', '${kb.artist}')">Confirm Artist</button>
                            <button class="btn-deny" onclick="performAction('deny', '${obs.title}', '${obs.artist}', '${kb.title}', '${kb.artist}')">Deny Artist</button>
                            <button class="btn-allow-title" onclick="performAction('allow_title_only', '${obs.title}', '${obs.artist}', '${kb.title}', '${kb.artist}')">Allow Title-Only</button>
                            <button class="btn-skip" onclick="loadAndDisplayEntries()">Skip</button>
                        </div>
                    `;
                    container.appendChild(entryDiv);
                });
            } catch (error) {
                statusElement.textContent = `Fehler beim Laden: ${error.message}`;
                console.error('Fehler beim Laden der Einträge:', error);
            } finally {
                loadingElement.style.display = 'none';
            }
        }

        async function performAction(action, obs_title, obs_artist, kb_title, kb_artist) {
            statusElement.textContent = `Führe Aktion ${action} aus...`;
            try {
                const response = await fetch(`/artist_not_sure_action`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: action,
                        observed_title: obs_title,
                        observed_artist: obs_artist,
                        kb_title: kb_title,
                        kb_artist: kb_artist
                    })
                });
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }
                const result = await response.json();
                if (result.success) {
                    statusElement.textContent = `Aktion erfolgreich: ${result.message}`;
                    // Nach erfolgreicher Aktion, lade die nächste Runde
                    setTimeout(() => loadAndDisplayEntries(), 1000);
                } else {
                    statusElement.textContent = `Fehler bei Aktion: ${result.message}`;
                }
            } catch (error) {
                statusElement.textContent = `Fehler bei Aktion: ${error.message}`;
                console.error('Fehler bei Aktion:', error);
            }
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "<")
                 .replace(/>/g, ">")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        // Lade die Einträge, wenn die Seite geladen wird
        document.addEventListener('DOMContentLoaded', loadAndDisplayEntries);
    </script>
</body>
</html>