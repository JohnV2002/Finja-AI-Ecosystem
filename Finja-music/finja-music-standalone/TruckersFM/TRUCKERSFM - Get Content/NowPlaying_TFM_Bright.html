<!-- ====================================================================== -->

<!--           Finja's Brain & Knowledge Core - TruckersFM                  -->

<!-- ====================================================================== -->

<!--                                                                        -->

<!--   Project: Finja - Twitch Interactivity Suite                          -->

<!--   Author: JohnV2002 (J. Apps / Sodakiller1)                            -->

<!--   Version: 1.0.0                                                       -->

<!--   Description: HTML für TruckersFM.                                    -->

<!--                                                                        -->

<!--   Copyright (c) 2025 J. Apps                                           -->

<!--   Licensed under the MIT License.                                      -->

<!-- ====================================================================== -->

<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TruckersFM Now Playing</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      background: transparent; overflow: hidden;
    }
    :root {
      --w: 760px;
      --padX: 20px;
      --padY: 16px;
      --radius: 18px;
      --shadow: 0 14px 36px rgba(0,0,0,.45);
      --glass: rgba(18,22,35,.55);
      --c1: #76f7ff;
      --c2: #a07aff;
      --txt: #f6fcff;
      --muted: #b8f7ff;
      --edge: 16px;
    }
    .wrap { position: fixed; inset: 0; pointer-events: none; }
    .card{
      position: absolute; top: var(--edge); left: 50%; transform: translateX(-50%);
      transform-origin: top center;
      width: min(var(--w), calc(100vw - (var(--edge)*2)));
      display: grid;
      grid-template-columns: 1fr auto;
      grid-template-rows: auto auto auto;
      grid-template-areas: "label label" "title title" "genres react";
      gap: 14px 16px;
      padding: var(--padY) var(--padX);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.12);
    }
    .card::before{
      content:""; position:absolute; inset:-2px; border-radius:inherit;
      background: linear-gradient(90deg, var(--c1), var(--c2)); filter: blur(12px);
      opacity:.7; z-index:-1;
    }
    .label{
      grid-area: label; font: 800 14px/1.1 system-ui, sans-serif;
      letter-spacing:.14em; text-transform: uppercase; color: var(--muted);
      text-shadow: 0 0 10px rgba(0,0,0,.6);
      display:flex; align-items:center; gap:10px;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background: linear-gradient(135deg, var(--c1), var(--c2));
      box-shadow: 0 0 10px rgba(118,247,255,.8);
    }
    .title{
      grid-area: title; font: 900 32px/1.18 system-ui, sans-serif; color: var(--txt);
      text-shadow: 0 0 20px rgba(0,0,0,.65), 0 0 36px rgba(118,247,255,.28);
      word-break: break-word; hyphens: auto;
    }
    .genres{
      grid-area: genres; display:flex; flex-wrap:wrap; gap:12px;
    }
    .chip{
      font: 800 18px/1.3 system-ui, sans-serif;
      padding: 10px 14px; border-radius:14px;
      background: rgba(255,255,255,.18); color:#eaf7ff;
      text-shadow: 0 0 10px rgba(0,0,0,.35);
      white-space: nowrap; max-width: 100%; overflow: hidden; text-overflow: ellipsis;
    }
    /* Special-Tags: weiße Outline, kein Farbwechsel am Theme */
    .chip--special{
      background: transparent;
      border: 1px solid rgba(255,255,255,.8);
      color: #ffffff;
      text-shadow: 0 0 10px rgba(0,0,0,.35);
    }

    .react{
      grid-area: react; justify-self:end; align-self:start;
      border-radius:16px; background: rgba(160,122,255,.25); color:#fff;
      box-shadow: 0 2px 10px rgba(0,0,0,.35);
      font: 800 16px/1.25 system-ui, sans-serif;
      padding: 8px 14px;
      /* Wichtige Anpassungen für sehr lange Texte: */
      max-width: 64ch;         /* vorher 40ch */
      white-space: normal;
      overflow-wrap: anywhere; /* lange Wörter/URLs umbrechen */
      word-break: normal;
      transition: opacity 2s ease;
    }

    @media (max-width: 600px){
      .title{ font-size:28px; }
      .chip { font-size:15px; }
      .react{ font-size:15px; max-width: 70vw; } /* auf schmalen Szenen etwas breiter relativ */
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card">
      <div class="label"><span class="dot"></span><span id="label">TruckersFM</span></div>
      <div class="title" id="np">Lade…</div>
      <div class="genres" id="genres"></div>
      <div class="react" id="react" style="display:none;"></div>
    </div>
  </div>

  <script>
    const qs = () => new URLSearchParams(location.hash.replace(/^#/, ''));
    const $  = s => document.querySelector(s);
    const setVar = (n,v) => v != null && document.documentElement.style.setProperty(n, v);

    (function init(){
      const p = qs();
      if (p.get('w'))   setVar('--w', p.get('w') + 'px');
      if (p.get('fs'))  $('.title').style.fontSize = p.get('fs') + 'px';
      if (p.get('label')) $('#label').textContent = p.get('label');
    })();

    async function readFile(path){
      try{
        const r = await fetch(path + (path.includes('?') ? '&' : '?') + 'ts=' + Date.now());
        if(!r.ok) throw 0;
        return (await r.text()).trim();
      }catch{ return ""; }
    }

    // Specials inkl. Bindestrich-Varianten abfangen
    const SPECIAL_PATTERNS = [
      /(^|\s)night[\s-]*core($|\s)/i,
      /(^|\s)speed[\s-]*up($|\s)/i,
      /(^|\s)sped[\s-]*up($|\s)/i,
      /(^|\s)speedup($|\s)/i,
      /(^|\s)radio[\s-]*edit($|\s)/i,
      /(^|\s)radio[\s-]*mix($|\s)/i,
      /(^|\s)tik[\s-]*tok($|\s)/i,
      /(^|\s)tiktok($|\s)/i
    ];
    function isSpecialTag(t){
      const s = (t||"").toLowerCase();
      return SPECIAL_PATTERNS.some(rx => rx.test(" "+s+" "));
    }

    function renderGenres(text){
      const box = $('#genres'); box.innerHTML = "";
      if(!text) return;

      // Split an • , |  (wie bisher)
      const parts = text.split(/•|,|\|/).map(s => s.trim()).filter(Boolean);

      // In zwei Gruppen aufteilen: normale Tags vs. Specials
      const normal = [];
      const special = [];
      for(const p of parts){
        if(isSpecialTag(p)) special.push(p);
        else normal.push(p);
      }

      // zuerst normale Tags
      for(const p of normal){
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.textContent = p;
        box.appendChild(chip);
      }

      // dann Specials (weiße Outline), nur wenn vorhanden
      for(const p of special){
        const chip = document.createElement('div');
        chip.className = 'chip chip--special';
        chip.textContent = p;
        box.appendChild(chip);
      }
    }

    let lastReact = "";

    async function update(){
      $('#np').textContent = (await readFile('nowplaying.txt')) || '—';
      renderGenres(await readFile('outputs/obs_genres.txt'));

      const react = (await readFile('outputs/obs_react.txt')) || "";
      const rEl = $('#react');

      if(!react){
        rEl.style.display = 'none';
        lastReact = "";
        return;
      }

      if(react !== lastReact){
        rEl.style.display = 'inline-block';
        rEl.style.opacity = 0;
        setTimeout(()=>{
          rEl.textContent = "Finjas Antwort: " + react;
          rEl.style.opacity = 1;
          lastReact = react;
        }, 20);
      }
    }

    update();
    setInterval(update, parseInt(qs().get('ms') || '3000', 10) || 3000);
  </script>
</body>
</html>
